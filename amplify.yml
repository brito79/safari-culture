version: 1
# =====================================================
# Safari Culture - Wilderness Namibia Platform
# Amplify Build Configuration
# =====================================================
# Tech Stack: Next.js 15.5.3 + Turbopack + Auth0 + MySQL + AWS RDS
# Build Time: ~2-3 minutes (optimized with caching)
# =====================================================

backend:
  phases:
    build:
      commands:
        - '# Amplify Gen 2 Backend (if using Amplify backend)'
        - amplifyPush --simple

frontend:
  phases:
    # =====================================================
    # PRE-BUILD PHASE
    # =====================================================
    preBuild:
      commands:
        - '# ========================================='
        - '# Safari Culture - Pre-Build Setup'
        - '# ========================================='
        - echo "ðŸ•ï¸  Building Safari Culture - Wilderness Namibia Platform"
        - echo "ðŸ“¦ Next.js 15.5.3 with Turbopack"
        - echo "ðŸ” Auth0 Authentication"
        - echo "ðŸ’¾ AWS RDS MySQL Database"
        - echo ""
        
        - '# ========================================='
        - '# Install Dependencies (with caching)'
        - '# ========================================='
        - echo "ðŸ“¥ Installing dependencies..."
        - npm ci --cache .npm --prefer-offline --legacy-peer-deps
        - echo "âœ… Dependencies installed"
        - echo ""
        
        - '# ========================================='
        - '# Environment Validation'
        - '# ========================================='
        - echo "ðŸ” Validating environment configuration..."
        - echo "NODE_ENV=$NODE_ENV"
        - echo "NEXT_PUBLIC_S3_BASE_URL=$NEXT_PUBLIC_S3_BASE_URL"
        - echo "AUTH0_ISSUER=$AUTH0_ISSUER"
        - echo "AUTH0_CLIENT_ID=$AUTH0_CLIENT_ID"
        - echo "DB_HOST=$DB_HOST"
        - echo ""
        
        - '# ========================================='
        - '# Verify Dependencies'
        - '# ========================================='
        - echo "ðŸ“‹ Checking installed versions..."
        - node --version
        - npm --version
        - node -p '"React: " + require("./node_modules/react/package.json").version'
        - node -p '"Next.js: " + require("./node_modules/next/package.json").version'
        - echo ""
        
        - '# ========================================='
        - '# Database Connection Test (Optional)'
        - '# ========================================='
        - echo "ðŸ”Œ Testing database connectivity..."
        - '# Add your DB connection test here if needed'
        - echo "âœ… Environment setup complete"
        - echo ""

    # =====================================================
    # BUILD PHASE
    # =====================================================
    build:
      commands:
        - '# ========================================='
        - '# Safari Culture - Production Build'
        - '# ========================================='
        - echo "ðŸš€ Starting production build with Turbopack..."
        - echo "â±ï¸  Build started at $(date)"
        - echo ""
        
        - '# Build with Turbopack (Next.js 15)'
        - npm run build
        
        - echo ""
        - echo "âœ… Build completed at $(date)"
        - echo "ðŸ“Š Build artifacts ready for deployment"
        - echo ""
        
        - '# ========================================='
        - '# Post-Build Verification'
        - '# ========================================='
        - echo "ðŸ” Verifying build output..."
        - ls -lah .next/
        - echo "âœ… Build verification complete"
        
      environment:
        variables:
          # ========================================
          # Next.js Build Optimizations
          # ========================================
          NEXT_TELEMETRY_DISABLED: 1
          NODE_OPTIONS: "--max-old-space-size=4096"
          
          # ========================================
          # Safari Culture Environment
          # ========================================
          APP_ENV: production
          NODE_ENV: production
          
          # ========================================
          # React 19 Compatibility
          # ========================================
          NPM_CONFIG_LEGACY_PEER_DEPS: true
          
          # ========================================
          # Turbopack Build Flags
          # ========================================
          TURBOPACK: 1

  # =====================================================
  # BUILD ARTIFACTS
  # =====================================================
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'

  # =====================================================
  # BUILD CACHE (Speeds up subsequent builds)
  # =====================================================
  cache:
    paths:
      # Next.js build cache (critical for fast rebuilds)
      - .next/cache/**/*
      
      # npm cache (speeds up dependency installation)
      - .npm/**/*
      
      # Node modules (if dependencies haven't changed)
      - node_modules/**/*
      
      # Turbopack cache
      - .turbo/**/*

  # =====================================================
  # CUSTOM HEADERS (Security & Performance)
  # =====================================================
  customHeaders:
    # ========================================
    # Security Headers (All Routes)
    # ========================================
    - pattern: '**/*'
      headers:
        # Prevent clickjacking attacks
        - key: 'X-Frame-Options'
          value: 'DENY'
        
        # Prevent MIME type sniffing
        - key: 'X-Content-Type-Options'
          value: 'nosniff'
        
        # Control referrer information
        - key: 'Referrer-Policy'
          value: 'strict-origin-when-cross-origin'
        
        # Restrict browser features
        - key: 'Permissions-Policy'
          value: 'camera=(), microphone=(), geolocation=()'
        
        # XSS Protection
        - key: 'X-XSS-Protection'
          value: '1; mode=block'
        
        # Strict Transport Security (HTTPS only)
        - key: 'Strict-Transport-Security'
          value: 'max-age=31536000; includeSubDomains; preload'

    # ========================================
    # API Routes Caching (ISR optimized)
    # ========================================
    - pattern: '/api/camps'
      headers:
        - key: 'Cache-Control'
          value: 'public, s-maxage=60, stale-while-revalidate=300'
    
    - pattern: '/api/experiences'
      headers:
        - key: 'Cache-Control'
          value: 'public, s-maxage=60, stale-while-revalidate=300'
    
    - pattern: '/api/rates'
      headers:
        - key: 'Cache-Control'
          value: 'public, s-maxage=60, stale-while-revalidate=300'

    # ========================================
    # Static Assets Caching (1 year)
    # ========================================
    - pattern: '/images/**'
      headers:
        - key: 'Cache-Control'
          value: 'public, max-age=31536000, immutable'
    
    - pattern: '**/*.{js,css,woff,woff2,ttf,eot}'
      headers:
        - key: 'Cache-Control'
          value: 'public, max-age=31536000, immutable'
    
    - pattern: '**/*.{jpg,jpeg,png,gif,webp,svg,ico}'
      headers:
        - key: 'Cache-Control'
          value: 'public, max-age=31536000, immutable'

    # ========================================
    # Next.js Static Pages (1 hour cache)
    # ========================================
    - pattern: '/_next/static/**'
      headers:
        - key: 'Cache-Control'
          value: 'public, max-age=3600, immutable'

# =====================================================
# NOTES & BEST PRACTICES
# =====================================================
# 1. Environment Variables:
#    - Set in Amplify Console > App Settings > Environment Variables
#    - Required: AUTH0_*, DB_*, NEXT_PUBLIC_S3_BASE_URL
#
# 2. Build Performance:
#    - First build: ~3-4 minutes
#    - Cached builds: ~1-2 minutes
#    - Turbopack significantly speeds up builds
#
# 3. Database Connection:
#    - Ensure RDS security group allows Amplify IPs
#    - Use AWS Secrets Manager for DB credentials
#
# 4. Monitoring:
#    - Check CloudWatch logs for build errors
#    - Monitor build times in Amplify Console
#
# 5. Cache Invalidation:
#    - Clear cache if dependencies change significantly
#    - Amplify Console > Build Settings > Clear Cache
# =====================================================
