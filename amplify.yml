version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Install dependencies with caching
        - echo "ðŸ“¦ Installing dependencies..."
        - npm ci --cache .npm --prefer-offline
        
        # Verify Node.js and npm versions
        - echo "ðŸ” Node version:" && node --version
        - echo "ðŸ” npm version:" && npm --version
        
        # Fetch secrets from AWS Secrets Manager (if NEXT_PUBLIC_SECRET_NAME is set)
        - |
          if [ ! -z "$NEXT_PUBLIC_SECRET_NAME" ]; then
            echo "ðŸ” Fetching database credentials from Secrets Manager..."
            SECRET_VALUE=$(aws secretsmanager get-secret-value --secret-id $NEXT_PUBLIC_SECRET_NAME --query SecretString --output text --region ${AWS_REGION:-us-east-1} || echo "")
            if [ ! -z "$SECRET_VALUE" ]; then
              export NEXT_PUBLIC_RDS_USER=$(echo $SECRET_VALUE | jq -r '.username // empty')
              export NEXT_PUBLIC_RDS_PASSWORD=$(echo $SECRET_VALUE | jq -r '.password // empty')
              echo "âœ… Secrets fetched successfully"
            else
              echo "âš ï¸  Failed to fetch secrets, will use environment variables"
            fi
          else
            echo "â„¹ï¸  NEXT_PUBLIC_SECRET_NAME not set, using environment variables"
          fi
        
        # Validate required environment variables
        - |
          echo "ðŸ” Validating environment variables..."
          MISSING_VARS=""
          [ -z "$NEXT_PUBLIC_RDS_HOST" ] && MISSING_VARS="$MISSING_VARS NEXT_PUBLIC_RDS_HOST"
          [ -z "$NEXT_PUBLIC_RDS_DATABASE" ] && MISSING_VARS="$MISSING_VARS NEXT_PUBLIC_RDS_DATABASE"
          [ -z "$AUTH0_SECRET" ] && MISSING_VARS="$MISSING_VARS AUTH0_SECRET"
          [ -z "$AUTH0_DOMAIN" ] && MISSING_VARS="$MISSING_VARS AUTH0_DOMAIN"
          [ -z "$AUTH0_CLIENT_ID_ID" ] && MISSING_VARS="$MISSING_VARS AUTH0_CLIENT_ID_ID"
          [ -z "$AUTH0_CLIENT_ID_SECRET" ] && MISSING_VARS="$MISSING_VARS AUTH0_CLIENT_ID_SECRET"
          
          if [ ! -z "$MISSING_VARS" ]; then
            echo "âŒ Missing required environment variables:$MISSING_VARS"
            exit 1
          fi
          echo "âœ… All required environment variables are set"
        
        # Test database connectivity (optional, can be disabled)
        - |
          if [ "$SKIP_DB_CHECK" != "true" ]; then
            echo "ðŸ” Testing database connectivity..."
            if command -v mysql &> /dev/null; then
              mysql -h $NEXT_PUBLIC_RDS_HOST -u ${NEXT_PUBLIC_RDS_USER:-admin} -p$NEXT_PUBLIC_RDS_PASSWORD -e "SELECT 1" 2>&1 | grep -q "ERROR" && echo "âš ï¸  Database connection test failed (non-blocking)" || echo "âœ… Database connection successful"
            else
              echo "â„¹ï¸  MySQL client not available, skipping connection test"
            fi
          fi
    
    build:
      commands:
        # Set production environment
        - export NODE_ENV=production
        
        # Build the Next.js application
        - echo "ðŸ—ï¸  Building Next.js application..."
        - npm run build
        
        # Verify build output
        - |
          if [ -d ".next" ]; then
            echo "âœ… Build completed successfully"
            echo "ðŸ“Š Build size:"
            du -sh .next
          else
            echo "âŒ Build failed - .next directory not found"
            exit 1
          fi
        
        # Generate build info
        - |
          echo "ðŸ“ Generating build metadata..."
          cat > .next/build-info.json << EOF
          {
            "buildTime": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commitSha": "${AWS_COMMIT_ID:-unknown}",
            "branch": "${AWS_BRANCH:-unknown}",
            "nodeVersion": "$(node --version)",
            "environment": "production"
          }
          EOF
          echo "âœ… Build metadata generated"
  
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  
  cache:
    paths:
      # Next.js build cache
      - .next/cache/**/*
      # npm cache
      - .npm/**/*
      # Node modules (if needed)
      - node_modules/**/*

# Environment variables configuration
# Note: Set these in the Amplify Console under App Settings > Environment Variables
# 
# Required Variables:
# - NEXT_PUBLIC_RDS_HOST
# - NEXT_PUBLIC_RDS_DATABASE  
# - NEXT_PUBLIC_RDS_USER (or use NEXT_PUBLIC_SECRET_NAME)
# - NEXT_PUBLIC_RDS_PASSWORD (or use NEXT_PUBLIC_SECRET_NAME)
# - AUTH0_SECRET
# - AUTH0_DOMAIN
# - AUTH0_CLIENT_ID_ID
# - AUTH0_CLIENT_ID_SECRET
# - AUTH0_ISSUER_BASE_URL
# - APP_BASE_URL
# - NEXT_PUBLIC_S3_BUCKET_NAME
# - NEXT_PUBLIC_S3_REGION
# - NEXT_PUBLIC_S3_BASE_URL
#
# Optional Variables:
# - NEXT_PUBLIC_SECRET_NAME (AWS Secrets Manager secret ID)
# - NEXT_PUBLIC_DB_CONNECTION_LIMIT (default: 10)
# - NEXT_PUBLIC_RDS_PORT (default: 3306)
# - AWS_REGION (default: us-east-1)
# - SKIP_DB_CHECK (set to "true" to skip database connectivity test)
#
# AWS Credentials (automatically provided by Amplify):
# - AWS_ACCESS_KEY_ID
# - AWS_SECRET_ACCESS_KEY
# - AWS_REGION
